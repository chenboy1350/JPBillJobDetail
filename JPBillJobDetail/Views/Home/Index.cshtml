@model PagedListModel<BillJobDetailModel, BillJobFilterModel>

@{
    ViewData["Title"] = "Home Page";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
}

<div class="card mb-4">
    <div class="card-header">
        <a class="btn btn-link text-decoration-none" data-bs-toggle="collapse" href="#searchPanel" role="button" aria-expanded="false" aria-controls="searchPanel">
            <i class="fa-solid fa-filter"></i> ค้นหาบิล
        </a>
    </div>
    <div class="collapse show" id="searchPanel">
        <div class="card-body">
            <form id="searchForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="ddlJobGroup">เลือกประเภทงาน</label>
                            <select id="ddlJobGroup" name="ddlJobGroup" class="form-control">
                                <option value="">-- เลือก ประเภทงาน --</option>
                                @if (ViewBag.JobGroupList != null)
                                {
                                    foreach (var item in ViewBag.JobGroupList)
                                    {
                                        <option value="@item.JobNum">@item.JobName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="ddlEmp">เลือกชื่อช่าง</label>
                            <select id="ddlEmp" name="ddlEmp" class="form-control" disabled>
                                <option value="">-- เลือก ช่าง --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="revDate">วันที่เริ่ม</label>
                                <input id="dtStart" name="dtStart" type="date" class="form-control" value="">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="revDate">วันที่สิ้นสุด</label>
                            <input id="dtEnd" name="dtEnd" type="date" class="form-control" value="">
                        </div>
                    </div>
                </div>
                <div class="row mt-3 d-flex justify-content-end">
                    <div class="col-md-9">
                        <div class="form-group d-flex justify-content-end">
                            <label>&nbsp;</label>
                            <div class="btn-group d-block">
                                <button type="button" id="clearBtn" class="btn btn-secondary">
                                    <i class="fa-solid fa-xmark"></i> ล้าง
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> ค้นหา
                                </button>
                                <button type="button" class="btn btn-success">
                                    <i class="fa-solid fa-print"></i> print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="billjob-list">
    @await Html.PartialAsync("_BillJobPartial", Model.Data.Items)
</div>

<div id="pagination-container">
    @await Html.PartialAsync("_PaginationPartial", Model)
</div>


@section Scripts {
    <script>
        let currentPage = @Html.Raw(currentPage);
        let currentPageSize = @Html.Raw(pageSize);
                
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const formattedToday = `${yyyy}-${mm}-${dd}`;

        $(document).ready(function () {
            $('#dtStart').val(formattedToday);
            $('#dtEnd').val(formattedToday);

            $('#ddlJobGroup').select2({
                placeholder: "-- เลือก ประเภทงาน --",
            });

            $('#ddlEmp').select2({
                placeholder: "-- เลือก ช่าง --",
            });

            $('#ddlJobGroup').on('change', function () {
                getTempProfile();
            });

            $('#searchForm').on('submit', function(e) {
                e.preventDefault();
                searchBillJob(1, currentPageSize);
            });

            $('#clearBtn').on('click', function () {
                clearSearch();
            });

            $(document).on('change', '#pageSize', function() {
                currentPageSize = $(this).val();
                searchBillJob(1, currentPageSize);
            });

            $(document).on('click', '.page-link[data-page]', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                searchBillJob(page, currentPageSize);
            });
        });

        function getTempProfile(){
            let jobNum = $('#ddlJobGroup').val();
            if (jobNum) {
                $.ajax({
                    url: '@Url.Action("TempProfile", "Home")',
                    type: 'GET',
                    data: { JobNum: jobNum },
                    success: function (data) {
                        var $ddlEmp = $('#ddlEmp');
                        $ddlEmp.empty();
                        $ddlEmp.append($('<option>', { value: '', text: '-- เลือก ช่าง --' }));
                        $.each(data, function (i, item) {
                            $ddlEmp.append($('<option>', { value: item.empCode, text: item.titleName + ' ' + item.name }));
                        });
                        $ddlEmp.prop('disabled', false);
                    },
                    error: function () {
                        alert('เกิดข้อผิดพลาดในการดึงข้อมูลช่าง');
                    }
                });
            } else {
                $('#ddlEmp').empty().append($('<option>', { value: '', text: '-- เลือก ช่าง --' }));
            }
        }

        function searchBillJob(page, pageSize) {
            let jobNum = $('#ddlJobGroup').val();
            let empCode = $('#ddlEmp').val();
            let dtStart = $('#dtStart').val();
            let dtEnd = $('#dtEnd').val();

            $('#loadingIndicator').show();
            $('#billjob-list').hide();
            $('#pagination-container').hide();

            $.ajax({
                url: '@Url.Action("BillJobDetail", "Home")',
                type: 'GET',
                data: {
                    JobNum: jobNum,
                    EmpCode: empCode,
                    DtStart: dtStart,
                    DtEnd: dtEnd,
                    Page: page,
                    PageSize: pageSize
                },
                success: function (response) {
                    if (response.success) {
                        $('#billjob-list').html(response.html);
                        $('#pagination-container').html(response.pagination);
                        currentPage = response.currentPage;
                        $('#billjob-list').show();
                        $('#pagination-container').show();
                     }
                },
                error: function () {
                     alert('เกิดข้อผิดพลาดในการค้นหาบิล');
                },
                complete: function() {
                     $('#loadingIndicator').hide();
                }
            });
        }

        function clearSearch() {
            $('#searchForm')[0].reset();
            $('#dtStart').val(formattedToday);
            $('#dtEnd').val(formattedToday);
            $('#ddlJobGroup').val('0').trigger('change');
            $('#ddlEmp').empty().append($('<option>', { value: '', text: '-- เลือก ช่าง --' })).prop('disabled', true);
            $('#tblBillJob tbody').empty().append(
                $('<tr>').append(
                    $('<td colspan="100%" class="text-center text-muted">').text('ไม่พบข้อมูล')
                )
            );
            $('#pagination-container').hide();
        }
    </script>
}